#!/usr/bin/env bash

LOCKFILE="/tmp/easyeffects-daemon.lock"

exec 200>"$LOCKFILE"
flock -n 200 || { notify-send "EasyEffects Daemon is already running."; exit 1; }

udevadm monitor -u -t seat -s input | while read -r line; do
  if [[ "$line" =~ "/devices/virtual/input" ]]; then
    if [[ "$line" =~ "add" ]]; then
      nohup easyeffects --gapplication-service & 
      notify-send 'Enabled EasyEffects'
    elif [[ "$line" =~ remove ]]; then
      if pgrep -f "easyeffects" > /dev/null; then
        killall easyeffects
        notify-send 'Disabled EasyEffects'
      fi
    fi
  fi
done
