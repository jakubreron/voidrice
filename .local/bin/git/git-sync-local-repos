#!/usr/bin/env bash

set -euo pipefail

cd "$LVIM_SHARE_DIR"

git local-repos | while read -r REPO; do
  GIT_STATUS="$(git -C "$REPO" status --porcelain)"

  BRANCH=$(git -C "$REPO" rev-parse --abbrev-ref HEAD)
  # BRANCH=$(git -C "$REPO" default-branch) # NOTE: switch to default and update

  if [ -z "$BRANCH" ]; then
    echo "❌ $(basename "$REPO") does not have a default branch."
    continue;
  fi

  if [ -n "$GIT_STATUS" ]; then
    echo "❗ $(basename "$REPO") has local changes, so it wasn't updated."
    continue;
  fi

  git -C "$REPO" checkout --quiet "$BRANCH"

  if git ls-remote --exit-code --heads origin "$BRANCH"; then
    git -C "$REPO" pull origin "$BRANCH"
  fi

  echo "✅ $(basename "$REPO") was updated on $(basename "$BRANCH")."
done
